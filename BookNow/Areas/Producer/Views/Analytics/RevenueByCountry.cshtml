@using BookNow.Application.DTOs.Analytics
@model ProducerAnalyticsInputDto

@{
    ViewData["Title"] = "Producer Revenue Analytics";
    var targetCurrency = ViewBag.SelectedCurrency;
}

<div class="container mt-5">

    <header class="row mb-4 pb-3 border-bottom">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="text-dark">🎬 Revenue Portfolio Breakdown</h2>
            <div class="text-end">
                <p class="mb-0 text-muted fst-italic">Data in <strong id="reportHeaderCurrency">@targetCurrency</strong> (converted using latest rates)</p>
            </div>
        </div>
    </header>

    <form id="analyticsForm" class="row mb-5 align-items-center">
        <div class="col-md-4 col-lg-3">
            <div class="form-floating">
                <select name="currency" id="currency" class="form-select" aria-label="Report Currency" required>
                    @foreach (var curr in Model.AvailableCurrencies)
                    {
                        <option value="@curr" selected="@(ViewBag.SelectedCurrency == curr)">@curr</option>
                    }
                </select>
                <label for="currency">Report Currency</label>
            </div>
        </div>

    </form>

    <div id="reportContainer" class="card shadow-lg border-0" style="min-height: 500px; display: none;">
        <div class="card-header bg-light border-bottom">
            <h4 class="mb-0 text-dark">Revenue Contributions by Country: <span id="currencyTitle" class="fw-bold text-primary">@targetCurrency</span></h4>
        </div>
        <div class="card-body p-4">

            <div id="loadingIndicator" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div>
                <p class="mt-3 fs-5 text-muted">Generating portfolio report...</p>
            </div>

            <div id="noDataMessage" class="alert alert-info text-center border-0" style="display: none;">
                <i class="bi bi-info-circle-fill me-2"></i> No confirmed revenue data available for your movie portfolio.
            </div>

            <canvas id="revenueChart" style="min-height: 450px; width: 100%;"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        let revenueChart = null;
        const apiUrl = '@Url.Action("GetStackedRevenueData", "Analytics", new { Area = "Producer" })';

        const COUNTRY_COLORS = {
            'USA': { bg: 'rgba(54, 162, 235, 0.9)', border: 'rgba(54, 162, 235, 1)' },   
            'IND': { bg: 'rgba(255, 99, 132, 0.9)', border: 'rgba(255, 99, 132, 1)' },   
            'GBR': { bg: 'rgba(75, 192, 192, 0.9)', border: 'rgba(75, 192, 192, 1)' },  
            'AUS': { bg: 'rgba(255, 159, 64, 0.9)', border: 'rgba(255, 159, 64, 1)' },  
            'JPN': { bg: 'rgba(153, 102, 255, 0.9)', border: 'rgba(153, 102, 255, 1)' }, 
        };
        const defaultCountryColor = { bg: 'rgba(200, 200, 200, 0.8)', border: 'rgba(100, 100, 100, 1)' };


        function updateChart(stackedData, currency) {
            const container = document.getElementById('reportContainer');
            const noData = document.getElementById('noDataMessage');
            const chartCanvas = document.getElementById('revenueChart');

            document.getElementById('loadingIndicator').style.display = 'none';
            container.style.display = 'block';
            chartCanvas.style.display = 'block';
            if (!stackedData || stackedData.length === 0) {
                if (revenueChart) revenueChart.destroy();
                noData.style.display = 'block';
                return;
            }

            noData.style.display = 'none';
            document.getElementById('currencyTitle').textContent = currency;
             document.getElementById('reportHeaderCurrency').textContent = currency;
            
            const movieLabels = stackedData.map(d => d.movieTitle);
            const countryCodes = Object.keys(COUNTRY_COLORS);
            const datasets = [];

            countryCodes.forEach(code => {
                let countryName = '';

                const countryData = {
                    label: stackedData
                        .flatMap(m => m.revenueBreakdown)
                        .find(c => c.countryCode === code)?.countryName || code,
                    data: [],
                    backgroundColor: COUNTRY_COLORS[code]?.bg || defaultCountryColor.bg,
                    borderColor: COUNTRY_COLORS[code]?.border || defaultCountryColor.border,
                    borderWidth: 1
                };

                stackedData.forEach(movie => {
                    const contribution = movie.revenueBreakdown.find(c => c.countryCode === code);
                    countryData.data.push(contribution ? contribution.revenue : 0);
                });

                datasets.push(countryData);
            });

            if (revenueChart) {
                revenueChart.destroy();
            }

            
            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: movieLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,


                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Movie Portfolio' },
                            grid: { display: false }
                        },
                        y: {
                            stacked: true, 
                            beginAtZero: true,
                          
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                                }
                            },
                            title: { display: true, text: `Revenue in ${currency}` }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true, 
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                               
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    label += ': ';
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(context.raw);
                                    return label;
                                },
                                footer: function(context) {
                                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return 'Total: ' + new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(total);
                                }
                            }
                        }
                    }
                }
            });
        }

  

        document.addEventListener('DOMContentLoaded', function () {

            const currencySelect = document.getElementById('currency');
            const form = document.getElementById('analyticsForm');

            currencySelect.addEventListener('change', function() {
                fetchData(currencySelect.value);
            });

            async function fetchData(currency) {

                const loadingIndicator = document.getElementById('loadingIndicator');
                const container = document.getElementById('reportContainer');

                if (!currency) return; 

               
                container.style.display = 'block';
                loadingIndicator.style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

               
                currencySelect.disabled = true;

                try {
                    const fullUrl = `${apiUrl}?currency=${currency}`;

                    const response = await fetch(fullUrl);

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();

                    updateChart(data, currency);

                } catch (error) {
                    console.error("Error fetching analytics data:", error);
                    alert('Failed to load data. Please check the console for details.');
                    if (revenueChart) revenueChart.destroy();
                    document.getElementById('noDataMessage').textContent = 'An error occurred while fetching the report.';
                    document.getElementById('noDataMessage').style.display = 'block';
                } finally {
                    currencySelect.disabled = false;
                    loadingIndicator.style.display = 'none';
                }
            }

            if (currencySelect.value) {
                fetchData(currencySelect.value);
            }
        });

    </script>
}