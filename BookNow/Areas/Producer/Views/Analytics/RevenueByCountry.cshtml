@using BookNow.Application.DTOs.Analytics
@model ProducerAnalyticsInputDto

@{
    ViewData["Title"] = "Producer Revenue Analytics";
    // Initialize targetCurrency for JavaScript
    var targetCurrency = ViewBag.SelectedCurrency;
}

<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-primary mb-4">🎬 Revenue by Country Report</h2>
            <p>View country-wise revenue for your movie, converted using today's exchange rates.</p>
            <hr />
        </div>
    </div>

    <form id="analyticsForm" class="row mb-5 align-items-end">

        <div class="col-md-5 mb-3">
            <label for="movieId" class="form-label">Select Movie</label>
            <select name="movieId" id="movieId" class="form-control" required>
                <option value="">-- Select a Movie --</option>
                @foreach (var movie in Model.AvailableMovies)
                {
                    <option value="@movie.MovieId">@movie.Title</option>
                }
            </select>
        </div>

        <div class="col-md-4 mb-3">
            <label for="currency" class="form-label">Report Currency</label>
            <select name="currency" id="currency" class="form-control" required>
                @foreach (var curr in Model.AvailableCurrencies)
                {
                    <option value="@curr" selected="@(ViewBag.SelectedCurrency == curr)">@curr</option>
                }
            </select>
        </div>

        <div class="col-md-3 mb-3">
            <button type="submit" id="generateButton" class="btn btn-primary w-100">Generate Report</button>
        </div>
    </form>

    <div id="reportContainer" class="card shadow" style="min-height: 400px; display: none;">
        <div class="card-header bg-light">
            <h4 class="mb-0">Revenue Breakdown in <span id="currencyTitle">@targetCurrency</span></h4>
        </div>
        <div class="card-body">
            <div id="loadingIndicator" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="mt-2">Generating report. This may be slightly slower on the first load of the day...</p>
            </div>
            <div id="noDataMessage" class="alert alert-warning text-center" style="display: none;">
                No confirmed revenue found for the selected filters.
            </div>
            <canvas id="revenueChart" style="height: 400px; width: 100%;"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // Global variables for the chart instance and API endpoint
        let revenueChart = null;
        // API URL is correctly generated by Razor
        const apiUrl = '@Url.Action("GetRevenueData", "Analytics", new { Area = "Producer" })';

        // Function to destroy and create the chart instance with new data
        function updateChart(data, currency) {
            const container = document.getElementById('reportContainer');
            const noData = document.getElementById('noDataMessage');

            // Hide loading/no data
            document.getElementById('loadingIndicator').style.display = 'none';
            container.style.display = 'block';

            if (!data || data.length === 0) {
                if (revenueChart) revenueChart.destroy();
                noData.style.display = 'block';
                return;
            }

            noData.style.display = 'none';
            document.getElementById('currencyTitle').textContent = currency;
            data.sort((a, b) => b.totalRevenue - a.totalRevenue);

            // 🌟 CRITICAL FIX: Use camelCase for DTO properties 🌟
           const countries = data.map(d => `${d.countryName} (${d.countryCode})`);
            const revenue = data.map(d => d.totalRevenue);

            // Destroy previous instance to prevent chart overlap
            if (revenueChart) {
                revenueChart.destroy();
            }

            // Render Horizontal Bar Chart
           const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: countries,
                    datasets: [{
                        label: `Total Revenue (${currency})`,
                        data: revenue,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                padding: {
                    left: 20,
                    right: 20
                }
            },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                         callback: function(value, index, values) {
                            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                        }
                    },
                            title: {
                                display: true,
                                text: `Revenue in ${currency}`
                            }
                        },
                        y: {
                    // Ensures the chart labels don't get cut off
                    grid: { display: false }
                }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    // Format the number to currency style
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Document Ready / Initialization ---
        document.addEventListener('DOMContentLoaded', function () {

            // --- Fetch Data Handler ---
            document.getElementById('analyticsForm').addEventListener('submit', async function (e) {
                e.preventDefault(); // STOP the full page refresh!

                const movieId = document.getElementById('movieId').value;
                const currency = document.getElementById('currency').value;
                const generateButton = document.getElementById('generateButton');
                const loadingIndicator = document.getElementById('loadingIndicator');
                const container = document.getElementById('reportContainer');

                if (!movieId || !currency) {
                    alert('Please select a Movie and a Report Currency.');
                    return;
                }

                // Show loading state and disable button
                container.style.display = 'block';
                loadingIndicator.style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';
                generateButton.disabled = true;

                try {
                    // Construct the query string
                    const fullUrl = `${apiUrl}?movieId=${movieId}&currency=${currency}`;

                    const response = await fetch(fullUrl);

                    if (!response.ok) {
                        // Throw error if HTTP status is 4xx or 5xx
                        throw new Error(`HTTP error! Status: ${response.status}. Response: ${await response.text()}`);
                    }

                    const data = await response.json();
                    console.log(data);
                    // Update the chart with the new data
                    updateChart(data, currency);

                } catch (error) {
                    console.error("Error fetching analytics data:", error);
                    // Update error message to include more detail if available
                    let errorMessage = error.message.includes('HTTP error')
                        ? error.message.split('. Response:')[0]
                        : 'An unexpected error occurred.';

                    alert('Failed to load data: ' + errorMessage);

                    // Show error state
                    if (revenueChart) revenueChart.destroy();
                    document.getElementById('noDataMessage').textContent = 'An error occurred while fetching the report.';
                    document.getElementById('noDataMessage').style.display = 'block';
                } finally {
                    // Re-enable button and hide loading indicator
                    generateButton.disabled = false;
                    loadingIndicator.style.display = 'none';
                }
            });
        });
    </script>
}