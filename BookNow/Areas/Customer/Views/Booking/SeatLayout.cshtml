@model BookNow.Application.DTOs.CustomerDTOs.BookingDTOs.SeatLayoutPageDTO
@using System.Linq

@{
    ViewData["Title"] = $"Select Seats for {Model.MovieTitle}";
    // Use the custom minimal layout
    Layout = "_Layout_SeatMap";
}

<div class="booking-page-container">

    <!-- HEADER: Movie & Show Details -->
    @* <div class="movie-header bg-dark text-white p-3 d-flex justify-content-between align-items-center shadow-sm">
        <div class="d-flex align-items-center">
            <a href="javascript:history.back()" class="text-white me-3"><i class="bi bi-arrow-left-short fs-2"></i></a>
            <div>
                <h5 class="mb-0 fw-bold text-truncate">@Model.MovieTitle (@Model.MovieLanguage)</h5>
                <p class="small text-muted mb-0">@Model.TheatreName | @Model.ScreenName | @Model.StartTime.ToString("ddd, dd MMM, hh:mm tt")</p>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-danger p-2 fs-6" id="tickets-count">0 Tickets</span>
        </div>
    </div> *@
    <div class="movie-header bg-dark text-white p-3 d-flex justify-content-between align-items-center shadow-sm">
        <div class="d-flex align-items-center">
            <a href="javascript:history.back()" class="text-white me-3"><i class="bi bi-arrow-left-short fs-2"></i></a>
            <div>
                <h5 class="mb-0 fw-bold text-truncate text-white">@Model.MovieTitle (@Model.MovieLanguage)</h5>
                <p class="small text-light-subtle mb-0">@Model.TheatreName | @Model.ScreenName | @Model.StartTime.ToString("ddd, dd MMM, hh:mm tt")</p>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-danger p-2 fs-6" id="tickets-count">0 Tickets</span>
        </div>
    </div>

    <!-- SEAT MAP AREA -->
    <div class="seat-map-wrapper container py-4 flex-grow-1">

        @* <div class="screen-indicator mb-5 mx-auto text-center p-2 rounded-3 shadow">
            <h5 class="mb-0 text-white fw-light">SCREEN THIS WAY</h5>
        </div> *@
        <div class="screen-indicator mb-5 mx-auto text-center p-2 rounded-3 shadow">
            <h5 class="mb-0 text-white fw-light"> Screen @Model.ScreenName</h5>
        </div>

        <div id="seat-map" class="d-flex flex-column align-items-center">
            @foreach (var rowGroup in Model.SeatsByRow)
            {
                <div class="seat-row d-flex justify-content-center align-items-center mb-1" data-row="@rowGroup.Key">
                    <div class="row-label me-3 fw-bold text-muted">@rowGroup.Key</div>

                    @foreach (var seat in rowGroup.Value)
                    {
                        var stateClass = seat.State switch
                        {
                            "Booked" => "seat-sold",
                            "Held" => "seat-held",
                            _ => "seat-available clickable-seat"
                        };

                        <div class="seat-item @stateClass"
                             data-seat-instance-id="@seat.SeatInstanceId"
                             data-price="@seat.Price.ToString("F2")"
                             data-row-version="@Convert.ToBase64String(seat.RowVersion)">
                            @seat.SeatIndex
                        </div>
                    }
                    <div class="row-label ms-3 fw-bold text-muted">@rowGroup.Key</div>
                </div>
            }
        </div>

        <!-- Legend -->
        <div class="seat-legend d-flex justify-content-center mt-5 small">
            <div class="me-3"><span class="legend-box seat-available"></span> Available</div>
            <div class="me-3"><span class="legend-box seat-selected"></span> Selected</div>
            <div class="me-3"><span class="legend-box seat-sold"></span> Sold</div>
            <div><span class="legend-box seat-held"></span> Locked</div>
        </div>
    </div>
</div>

<!-- FOOTER: Price Summary and Action Button (Fixed Position) -->
<div id="booking-footer" class="fixed-bottom-bar border-top p-3 bg-white shadow-lg">
    <div class="container d-flex justify-content-between align-items-center">
        <div id="summary-display">
            <span class="fw-bold">Seats:</span> <span id="num-seats" class="me-3 text-danger">0</span>
            @* <span class="fw-bold">Total:</span> @Model.CurrencySymbol<span id="total-price" class="fs-5 text-success">0.00</span> *@
            <span class="fw-bold">Total:</span>
            <span id="currency-symbol">@Model.CurrencySymbol</span>
            <span id="total-price" class="fs-5 text-success">0.00</span>

        </div>

        <button id="btn-pay" class="btn btn-lg btn-danger" disabled data-show-id="@Model.ShowId">
            Pay @Model.CurrencySymbol<span id="btn-price-display">0.00</span>
        </button>
    </div>
</div>

<!-- Modal for Login Prompt/Error Messages -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="statusModalLabel">Action Required</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer" id="modal-footer-content">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/booking/seat-selection.js" asp-append-version="true"></script>
}
